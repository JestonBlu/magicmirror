ARG buildarch
FROM ${buildarch}node:lts-buster-slim as builder

USER root

WORKDIR /opt/magic_mirror

# copy startscripts into container:
COPY entrypoint.sh /tmp/

RUN set -e; \
    apt-get update; \
    DEBIAN_FRONTEND=noninteractive apt-get -qy --no-install-recommends install git ca-certificates; \
    apt-get clean; \
    rm -rf /var/lib/apt/lists/*; \
    chmod +x /tmp/entrypoint.sh; \
    chown node:node /tmp/entrypoint.sh; \
    chown -R node:node .;

USER node

ARG BuildRef
ARG GitRepo
RUN set -e; \
    node -v; \
    echo BuildRef="${BuildRef}"; \
    echo GitRepo="${GitRepo}"; \
    git clone --depth 1 -b "${BuildRef}" --single-branch "${GitRepo}" .; \
    git log -1; \
    if [ $(echo "${BuildRef}" | grep -E "^v[0-9]+.[0-9]+.[0-9]+$") ] ; then \
      npm ci --only=production; \
    else \
      # test updated dependencies
      sed -i "s|\"eslint\": \".*\"|\"eslint\": \"\^7.14.0\"|g" package.json; \
      sed -i "s|\"feedme\": \".*\"|\"feedme\": \"\^2.0.1\"|g" package.json; \
      sed -i "s|\"simple-git\": \".*\"|\"simple-git\": \"\^2.24.0\"|g" package.json; \
      sed -i "s|\"socket.io\": \".*\"|\"socket.io\": \"\^3.0.3\"|g" package.json; \
      npm install --only=production; \
    fi; \
    cat package.json; \
    npm cache clean -f; \
    rm -rf /home/node/.cache; \
    sed -i "s:address\: \"localhost\":address\: \"0.0.0.0\":" config/config.js.sample; \
    sed -i "s:ipWhitelist\: \[.*\],:ipWhitelist\: \[\],:" config/config.js.sample; \
    mkdir mount_ori; \
    mv modules mount_ori/; \
    mv config mount_ori/; \
    mv css mount_ori/; \
    mv /tmp/entrypoint.sh .; \
    # remove unused test stuff which causes CVE's:
    rm -rf node_modules/clarinet/benchmark; \
    # remove md files:
    find . -name "*.md" -delete;

FROM scratch
LABEL maintainer="Karsten Hassel"

COPY --from=builder /opt/magic_mirror /opt/magic_mirror
