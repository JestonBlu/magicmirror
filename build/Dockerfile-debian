ARG buildarch
ARG BUILDER_IMG
FROM ${BUILDER_IMG} as builder
FROM ${buildarch}node:lts-buster-slim
LABEL maintainer="Karsten Hassel"

USER root

WORKDIR /opt/magic_mirror

# copy startscripts into container:
COPY *.sh /opt/magic_mirror/

# procps, arp-scan and sudo needed for the module MMM-NetworkScanner
# sudo needed for the module MMM-Remote-Control
# sudo needed for cp in entrypoint
ARG buildarch
RUN set -e; \
    apt-get update; \
    _pck="git nano sudo gettext openssl ca-certificates wget"; \
    [ -z "${buildarch}" ] || _pck="${_pck} libgtk-3-0 libx11-xcb-dev libnss3-dev libxss1 libxtst6 libasound2 libdrm2 libgbm1 procps arp-scan"; \
    DEBIAN_FRONTEND=noninteractive apt-get -qy --no-install-recommends install ${_pck}; \
    apt-get clean; \
    rm -rf /var/lib/apt/lists/*; \
    usermod -a -G video node; \
    echo "node ALL=(ALL) NOPASSWD: ALL" >> /etc/sudoers; \
    chmod +x *.sh; \
    chown node:node *.sh; \
    touch restore.sh; \
    c_rehash;

USER node

COPY --from=builder --chown=node:node /opt/magic_mirror /opt/magic_mirror

ENV ELECTRON_DISABLE_SANDBOX=1 \
    NODE_ENV=production \
    MM_OVERRIDE_DEFAULT_MODULES=true \
    MM_OVERRIDE_CSS=true

EXPOSE 8080

ENTRYPOINT ["./entrypoint.sh"]